<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mullo</title>
<style>
body { margin:0; overflow:hidden; font-family:sans-serif; background:#222; color:white; }
canvas { display:block; background:#222; }
#mainMenu, #gameUI { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; justify-content:center; align-items:center; flex-direction:column; }
#mainMenu { background:#222; }
button { padding:10px 20px; margin:10px; font-size:20px; cursor:pointer; }
#status { position:absolute; top:10px; left:10px; font-weight:bold; }
#usernameContainer { position:absolute; top:10px; right:10px; }
#usernameContainer input, #usernameContainer button { margin:2px; padding:5px; }
</style>
</head>
<body>

<div id="mainMenu">
    <h1 style="font-size:50px; margin-bottom:50px;">Mullo</h1>
    <button id="connectBtn">Connect?</button>
</div>

<div id="gameUI" style="display:none;">
    <div id="status">OFFLINE</div>
    <div id="usernameContainer">
        <input id="usernameInput" placeholder="Enter username" />
        <button id="setUsernameBtn">Set Username</button>
    </div>
    <canvas id="gameCanvas"></canvas>
</div>

<script>
const mainMenu = document.getElementById("mainMenu");
const connectBtn = document.getElementById("connectBtn");
const gameUI = document.getElementById("gameUI");

connectBtn.onclick = () => {
    mainMenu.style.display = "none";
    gameUI.style.display = "block";
    startGame();
};

function startGame(){
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const statusDiv = document.getElementById("status");
    const usernameInput = document.getElementById("usernameInput");
    const setUsernameBtn = document.getElementById("setUsernameBtn");

    // Create a unique ID for this player
    const localId = Math.random().toString(36).substring(2,9);
    let username = "Player" + localId;
    const color = getRandomColor();

    // Players object synced across tabs
    let players = {};
    players[localId] = { x: Math.random()*canvas.width, y: Math.random()*canvas.height, color, username };

    // BroadcastChannel to sync players
    const channel = new BroadcastChannel("mullo");
    channel.onmessage = e => {
        players = { ...players, ...e.data };
        statusDiv.textContent = "ONLINE";
        statusDiv.style.color = "lime";
    };

    // Movement
    const keys = {};
    window.addEventListener("keydown", e=>keys[e.key]=true);
    window.addEventListener("keyup", e=>keys[e.key]=false);

    const speed = 5;
    function movePlayer(){
        let dx=0, dy=0;
        if(keys["ArrowUp"]||keys["w"]) dy -= speed;
        if(keys["ArrowDown"]||keys["s"]) dy += speed;
        if(keys["ArrowLeft"]||keys["a"]) dx -= speed;
        if(keys["ArrowRight"]||keys["d"]) dx += speed;
        players[localId].x += dx;
        players[localId].y += dy;
    }

    // Username change
    setUsernameBtn.onclick = () => {
        const name = usernameInput.value.trim();
        if(name){
            username = name;
            players[localId].username = username;
        }
    };

    // Broadcast local player position and username
    function broadcast(){
        channel.postMessage({ [localId]: players[localId] });
    }

    // Draw all players
    function drawPlayers(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        for(let id in players){
            const p = players[id];
            ctx.fillStyle = p.color;
            ctx.beginPath();
            ctx.arc(p.x,p.y,20,0,Math.PI*2);
            ctx.fill();
            ctx.fillStyle = "white";
            ctx.font = "16px Arial";
            ctx.textAlign = "center";
            ctx.fillText(p.username, p.x, p.y-30);
        }
    }

    function gameLoop(){
        movePlayer();
        broadcast();
        drawPlayers();
        requestAnimationFrame(gameLoop);
    }

    gameLoop();
}

// Random color generator
function getRandomColor(){
    const letters = "0123456789ABCDEF";
    let color = "#";
    for(let i=0;i<6;i++) color += letters[Math.floor(Math.random()*16)];
    return color;
}
</script>

</body>
</html>
